name: 8.0 PHPUnit

on:
  push:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'skip-github-actions')"
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Cache Docker php-image
      id: docker-php-image-cache
      uses: actions/cache@v3
      with:
        path: /tmp/docker-save
        key: ${{ runner.os }}-docker-php-build-save-${{ hashFiles('**/Dockerfile.php.common', '**/Dockerfile.php80') }}
    - run: docker load -i /tmp/docker-save/snapshot.tar || true
      if: steps.docker-php-image-cache.outputs.cache-hit == 'true'
    - run: ls -l && docker build -f build/Dockerfile.php80 -t app/php-image --cache-from=app/php-image-cache ./build
      if: steps.docker-php-image-cache.outputs.cache-hit != 'true'
      env:
        DOCKER_BUILDKIT: '1'
        COMPOSE_DOCKER_CLI_BUILD: '1'
    - run: docker tag app/php-image app/php-image-cache && mkdir -p /tmp/docker-save && docker save app/php-image-cache -o /tmp/docker-save/snapshot.tar && ls -lh /tmp/docker-save || true
      if: always() && steps.docker-php-image-cache.outputs.cache-hit != 'true'

    - name: Docker boot
      env:
        DOCKER_BUILDKIT: '1'
        COMPOSE_DOCKER_CLI_BUILD: '1'
        SERVICES_NAME: "app80 mysql mysql80"
      run: docker-compose up -d $SERVICES_NAME
      timeout-minutes: 4

    - name: Docker eficode/wait-for MySQL 5.7
      run: wget -qO- https://raw.githubusercontent.com/eficode/wait-for/v2.2.3/wait-for | sh -s -- 127.0.0.1:3306 -- echo success
      timeout-minutes: 1

    - name: Docker eficode/wait-for MySQL 8.0
      run: wget -qO- https://raw.githubusercontent.com/eficode/wait-for/v2.2.3/wait-for | sh -s -- 127.0.0.1:4306 -- echo success
      timeout-minutes: 1

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}-composer-dev

    - name: Docker install dependencies
      run: docker-compose exec -T app80 composer install

    - name: Sleep
      run: sleep 10

      # Docs: https://phpunit.readthedocs.io/en/9.5/
    - name: Docker run PHPUnit
      run: docker-compose exec -T app80 composer app-phpunit
