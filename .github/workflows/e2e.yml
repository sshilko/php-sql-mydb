name: Docker PHP7 Mysql5.7 PHPUnit with coverage

on:
  push:
    branches: [ "master" ]

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest
    timeout-minutes: 6

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Docker build
      run: docker-compose build

    - name: Docker boot
      run: docker-compose up -d --wait
      timeout-minutes: 3

    - name: Docker install dependencies
      run: docker-compose exec app composer install --dev

    - name: Docker install dependencies
      run: docker-compose exec app composer install --dev

      # Docs: https://phpunit.readthedocs.io/en/9.5/
    - name: Docker run PHPUnit
      run: docker-compose exec app composer app-phpunit-coverage

      # Docs: https://github.com/marketplace/actions/phpunit-coverage-badge
    - name: Generate PHPUnit coverage badge
      uses: timkrase/phpunit-coverage-badge@v1.2.0
      with:
        coverage_badge_path: '/doc/phpunit-coverage-badge.svg'
        push_badge: true
        report: test/clover.xml
        repo_token: ${{ secrets.GITHUB_TOKEN }}

