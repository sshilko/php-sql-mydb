# This file is part of the sshilko/php-sql-mydb package.
#
# (c) Sergei Shilko <contact@sshilko.com>
#
# MIT License
#
# For the full copyright and license information, please view the LICENSE
# file that was distributed with this source code.
version: '3.7'
services:
  #@see https://hub.docker.com/_/mysql
  mysql:
    tty: true
    dns: 1.1.1.1
    image: "mysql:5.7"
    stop_grace_period: 30s
    command:
      - --group-concat-max-len=9223372036854775807
      - --innodb-flush-log-at-trx-commit=2
      - --innodb-flush-neighbors=0
      - --innodb-lock-wait-timeout=20
      - --default-authentication-plugin=mysql_native_password
      - --skip-character-set-client-handshake
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_general_ci
      - --character-set-filesystem=binary
      - --disable-log-bin
      - --binlog-format=ROW
      - --lock-wait-timeout=20
      - --innodb-log-buffer-size=16777216
      - --innodb-max-dirty-pages-pct=60
      - --innodb-thread-concurrency=0
      - --sync-binlog=0
      - --skip-innodb-buffer-pool-dump-at-shutdown
      - --max_allowed_packet=10485760
      - --max-connections=1000
      - --innodb-file-per-table
      - --sql-mode=TRADITIONAL
      - --skip-performance-schema
      - --innodb-buffer-pool-size=268435456
      - --skip-name-resolve
    healthcheck:
      test: ["CMD", "mysqladmin", "-utest", "-ppass", "ping"]
      timeout: 15s
      start_period: 10s
    logging:
      options:
        max-size: "50m"
        max-file: "2"
    labels:
      - mydb1
    environment:
      MYSQL_DATABASE: mydb
      MYSQL_USER: test
      MYSQL_PASSWORD: pass
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3306:3306/tcp"
    expose:
      - "3306"
    sysctls:
      net.core.somaxconn: 4096
    volumes:
      - ./../test/fixtures/mysql/:/docker-entrypoint-initdb.d:ro
      - /tmp/dbdata:/var/lib/mysql/
    ulimits:
      nproc: 65535
      nofile:
        soft: 262140
        hard: 262140
    restart: "no"
